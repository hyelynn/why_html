<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ART BY US</title>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

    <!-- Bootstrap 4.3.1 -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- Custom -->
    <link rel="stylesheet" href="/css/custom.css">
    <link rel="stylesheet" href="/css/custom_host.css">

    <!-- Fontawesome -->
    <link rel="stylesheet" href="/css/fontawesome/css/all.min.css">

    <script src="/js/include.js"></script>
    <!-- Custom -->

    <script type="text/javascript" src="https://static.nid.naver.com/js/naveridlogin_js_sdk_2.0.0.js"
        charset="utf-8"></script>
    <script src="/js/kakao_sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>

    <script>
        Kakao.init('d88bea310f4a39afbea3146fe1c0fa72');
        Kakao.isInitialized();
    </script>
</head>

<body>
    <modal include-html="/include/header.html"></modal>
    <div class="py-md-3 px-5 py-2 text-center text-white bg-deep-dark top-notice">
        <span class="font-weight-light">코로나19에 대한 아트바이어스의 대책 및 환불 정책에 대한 최신 정보를 확인하세요.</span>
        <a href="#x" class="text-white d-lg-inline-block d-block">자세히 알아보기</a>
    </div>

    <nav class="navbar navbar-expand-lg navbar-light py-lg-3 py-1">
        <div class="container">
            <a class="navbar-brand" href="/index.html"><img src="http://artbyus.co.kr/img/logo.png"
                    srcset="http://artbyus.co.kr/img/logo@2x.png 2x, http://artbyus.co.kr/img/logo@3x.png 3x"></a>
            <div class="ml-auto align-items-center d-lg-none d-flex">
                <a class="text-dark mr-3 font-size-sm" href="/member/calendar.html"><i
                        class="far fa-calendar-alt"></i></a>
                <a class="text-dark mr-3 font-size-sm" href="/member/recent_list.html"><i
                        class="far fa-clock"></i></a>
                <a class="text-dark mr-2 font-size-sm" href="/member/purchase.html"><i
                        class="fas fa-shopping-cart"></i></a>
            </div>
            <button class="navbar-toggler border-0 font-size-md text-dark" type="button" data-toggle="collapse"
                data-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false"
                aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>

            <div class="collapse navbar-collapse" id="navbarNavDropdown"></div>
        </div>
    </nav>
    <script src="/js/header.js"></script>

    <main role="main">
        <div class="border-bottom mt-lg-5 mt-4">
            <div class="container">
                <div class="d-flex text-center">
                    <a class="bg-yellow d-block text-decoration-none text-dark font-size-s w-lg-20 py-md-3 py-2 px-lg-0 px-3"
                        href="qna_list.html">Q&A 관리</a>
                    <a class="border border-bottom-0 d-block text-decoration-none text-dark font-size-s w-lg-20 py-md-3 py-2 px-lg-0 px-3"
                        href="review_list.html">이용 후기 관리</a>
                </div>
            </div>
        </div>

        <div class="container my-3" id="qna_text">
            <!-- 검색 및 정렬 -->
            <div class="d-lg-flex mb-3 custom-inputs-sub host-top-function host-search-bar">
                <div class="input-group search-bar-solid">
                    <input type="text" id="searchText" class="form-control text-dark search-text" placeholder="작성자로 검색해주세요"
                        aria-label="작성자로 검색해주세요" aria-describedby="search-question">
                    <div class="input-group-append">
                        <button type="button" onclick="searchWriter();" class="btn bg-yellow text-gray">검색</button>
                    </div>
                </div>
                <select id="selectVal" class="form-control font-weight-light ml-auto mt-lg-0 mt-3">
                    <option value="1">답변완료순</option>
                    <option value="2">답변필요순</option>
                    <option value="3">최신 등록일 순</option>
                </select>

            </div>
        </div>
    </main>

    <footer include-html="/include/footer.html"></footer>

    <script src="/js/naver_login.js"></script>
    <script src="/js/login.js"></script>

    <script>includeHTML({});</script>
    <script>login_header();</script>

    <script type="text/javascript">
        function onLogout() {
            sessionStorage.clear();
            location.href = "index.html";
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

    <script src="/js/custom.js"></script>

    <script>
        var qnaList;

        function searchWriter(){
            var tempList = [];
            var writer = document.getElementById("searchText").value;
            for(var i = 0; i<qnaList.length;i++){
                var studio_temp = qnaList[i];
                if(studio_temp.user_id.indexOf(writer) == 0){
                    tempList.push(studio_temp);
                }
            }
            $("div[id^='qnaItem']").remove();
            writeHtml(tempList);
        }

        // 수정 input 활성화
        function handleQna(id) {
            console.log(id)
            let answer_text = $.trim($('#qnaItem' + id).find('p.answer').text());
            $('#qnaItem' + id).find('div.card-body').hide();
            $('#qnaItem' + id).find('div.accordion-textarea').show().find('textarea').val(answer_text).focus();
        }

        function goAns(id){
            var ans = document.getElementById("ans_"+id).value;
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (xhr.readyState === xhr.DONE) { 
                    if (xhr.status === 200 || xhr.status === 201) {
                        location.reload();
                        $('#qnaItem' + id).find('div.card-body').show();

                    } else {
                        alert("답변이 등록되지 않았습니다. 다시 시도해 주세요.");
                    }
                }else{
                }
            };
            console.log(id + " : " + ans);
            xhr.open('POST', 'http://3.34.150.116:3000/studio/qna/apply',true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.send("id="+id+"&answer="+ans); 
        }
        
        function noAnsSort(){
            var tempList = [];
            for(var i = 0; i<qnaList.length;i++){
                var studio_temp = qnaList[i];
                if(studio_temp.qna_answer == null){
                    tempList.push(studio_temp);
                }
            }
            for(var i = 0; i<qnaList.length;i++){
                var studio_temp = qnaList[i];
                if(studio_temp.qna_answer != null){
                    tempList.push(studio_temp);
                }
            }
            writeHtml(tempList);
        }

        function AnsSort(){
            var tempList = [];
            for(var i = 0; i<qnaList.length;i++){
                var studio_temp = qnaList[i];
                if(studio_temp.qna_answer != null){
                    tempList.push(studio_temp);
                }
            }
            for(var i = 0; i<qnaList.length;i++){
                var studio_temp = qnaList[i];
                if(studio_temp.qna_answer == null){
                    tempList.push(studio_temp);
                }
            }
            writeHtml(tempList);
        }
        
        function recentSort(a, b) { if(a.qna_date == b.qna_date){ return 0} return a.qna_date < b.qna_date ? 1 : -1; }

        $("#selectVal").change(function (){
            var num = $("#selectVal option:selected").val();
            switch(num){
                case "1":{
                    $("div[id^='qnaItem']").remove();
                    AnsSort();
                    break;
                }
                case "2":{
                    $("div[id^='qnaItem']").remove();
                    noAnsSort();
                    break;
                }
                default:{
                    $("div[id^='qnaItem']").remove();
                    qnaList.sort(recentSort);
                    writeHtml(qnaList);

                    break;
                }
            }
        });

        function writeHtml(studio_list){
            for(var i = 0; i<studio_list.length;i++){
                var studio_temp = studio_list[i];
                var re_studio = '';
                console.log(studio_temp.qna_answer);
                if(studio_temp.qna_answer == null ){
                    re_studio ='<div class="accordion host-accordion text-gray mb-lg-5 mb-3" id="qnaItem'+studio_temp.qna_no+'">'
                                    +'<div class="card">'
                                        +'<div class="card-header d-flex justify-content-between align-items-center" id="itemHeading'+studio_temp.qna_no+'">'
                                            +'<div class="mr-lg-5 mr-3">'
                                                +'<span class="state-text incomplete">답변필요</span>'
                                                +'<span class="ml-2 font-weight-light state-text">작성자 : '+studio_temp.user_id+'</span>'
                                                +'<p class="my-2"> '+studio_temp.qna_msg+' </p>'
                                                +'<span class="state-text bottom">'+studio_temp.studio_name
                                                    +'<span class="ml-md-4 d-md-inline-block d-block">'+moment(studio_temp.qna_date).format('YYYY-MM-DD HH:mm')+'</span>'
                                                +'</span>'
                                            +'</div>'
                                            +'<button class="btn accordion-btn" type="button" data-toggle="collapse" data-target="#itemCollapse'+studio_temp.qna_no+'" aria-expanded="true" aria-controls="itemCollapse'+studio_temp.qna_no+'">'
                                                +'<i class="fas fa-angle-double-up"></i>'
                                            +'</button>'
                                        +'</div>'
                                        +'<div id="itemCollapse'+studio_temp.qna_no+'" class="collapse show" aria-labelledby="itemHeading'+studio_temp.qna_no+'" data-parent="#qnaItem'+studio_temp.qna_no+'">'
                                            +'<div class="input-group border-top accordion-textarea">'
                                                +'<textarea id="ans_'+studio_temp.qna_no+'" class="form-control text-dark border-0" placeholder="답변을 작성해 주세요" aria-describedby="write-answer"></textarea>'
                                                +'<div class="input-group-append">'
                                                    +'<button type="button" onclick="goAns('+studio_temp.qna_no+');" class="btn bg-yellow rounded-0 text-gray">답변</button>'
                                                +'</div>'
                                            +'</div>'
                                        +'</div>'
                                    +'</div>'
                                +'</div>';
                }else{
                    re_studio = '<div class="accordion host-accordion text-gray mb-lg-5 mb-3" id="qnaItem'+studio_temp.qna_no+'">'
                                    +'<div class="card">'
                                        +'<div class="card-header d-flex justify-content-between align-items-center" id="itemHeading'+studio_temp.qna_no+'">'
                                            +'<div class="mr-lg-5 mr-3">'
                                                +'<span class="state-text complete">답변완료</span>'
                                                +'<span class="ml-2 font-weight-light state-text">작성자 : '+studio_temp.user_id+'</span>'
                                                +'<p class="my-2"> '+studio_temp.qna_msg+' </p>'
                                                +'<span class="state-text bottom">'+studio_temp.studio_name
                                                    +'<span class="ml-md-4 d-md-inline-block d-block">'+moment(studio_temp.qna_date).format('YYYY-MM-DD HH:mm')+'</span>'
                                                +'</span>'
                                            +'</div>'
                                            +'<button class="btn accordion-btn" type="button" data-toggle="collapse"'
                                            +'data-target="#itemCollapse'+studio_temp.qna_no+'" aria-expanded="true" aria-controls="itemCollapse'+studio_temp.qna_no+'">'
                                                +'<i class="fas fa-angle-double-up"></i>'
                                            +'</button>'
                                        +'</div>'
                                        +'<div id="itemCollapse'+studio_temp.qna_no+'" class="collapse" aria-labelledby="itemHeading'+studio_temp.qna_no+'" data-parent="#qnaItem'+studio_temp.qna_no+'">'
                                    +'<div class="card-body">'
                                        +'<span class="state-text">답변</span>'
                                        +'<p class="my-2 answer"> '+studio_temp.qna_answer+' </p>'
                                        +'<span class="state-text bottom">'+moment(studio_temp.qna_answer_date).format('YYYY-MM-DD HH:mm')+'</span>'
                                        +'<button type="button" class="btn ml-4 state-text edit-btn" onclick="handleQna('+studio_temp.qna_no+')">수정</button>'
                                    +'</div>'

                                    +' <div class="input-group border-top accordion-textarea" style="display: none">'
                                        +'<textarea id="ans_'+studio_temp.qna_no+'" class="form-control text-dark border-0" placeholder="답변을 작성해 주세요" aria-describedby="write-answer"></textarea>'
                                        +'<div class="input-group-append">'
                                            +'<button type="button" onclick="goAns('+studio_temp.qna_no+');" class="btn bg-yellow rounded-0 text-gray">답변</button>'
                                        +'</div>'
                                    +'</div>'
                                +' </div>'
                            +'</div>'
                        +'</div>';
                    }
                $("#qna_text").append(re_studio);
            }
        }

        $(document).ready(function (){
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (xhr.readyState === xhr.DONE) { 
                    if (xhr.status === 200 || xhr.status === 201) {
                        qnaList = JSON.parse(xhr.responseText);
                        writeHtml(qnaList);
                    } else {
                        alert("목록이 정상적으로 이루어지지 않았습니다. 다시 시도해주세요.");
                        console.error(xhr.responseText);
                    }
                }else{
                    
                }
            };
            xhr.open('POST', 'http://3.34.150.116:3000/studio/qna/host',true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.send("id="+sessionStorage.getItem("id"));
        });

        // 아코디언 collapse
        $('.host-accordion').on('show.bs.collapse', function () {
            $(this).find('i').attr('class', 'fas fa-angle-double-up')
        })
        $('.host-accordion').on('hide.bs.collapse', function () {
            $(this).find('i').attr('class', 'fas fa-angle-double-down')
        })
    </script>
</body>

</html>